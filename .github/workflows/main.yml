name: CI/CD workflow

on:
    workflow_dispatch: 

jobs: 
    LintAllPy:
        runs-on: ubuntu-latest

        # allows you to run mutiple versions of python to test it on
        strategy:
            matrix:
                python-version: [3.11] 

        steps:
            - name: checkout code 
              uses: actions/checkout@v6

            - name: set up python
              uses: actions/setup-python@v4
              with: 
                python-version: ${{ matrix.python-verion }}

            - name: install python vitrual enviromnet
              run: pip install virtualenv
            
            - name: virtualenv
              uses: actions/cache@v3
              id: cache-venv
              with: 
                path: venv
                key: ${{ runner.os }}-venv-${{ hashFiles('**/requirements.txt') }}
                restore-keys: |
                    ${{ runner.os }}-venv-
            
            - name: activate virtual environment
              run: python -m venv venv && source venv/bin/activate && python -m pip install --upgrade pip && pip install flake8 && pip3 install -r requirements.txt

            - name: lint with flakes backend
              run: |
                . venv/bin/activate && flake8 backend/
            
            - name: lint with flakes frontend
              run: |
                . venv/bin/activate && flake8 frontend/
            
            - name: lint with flakes testing
              run: |
                . venv/bin/activate && flake8 testing/

    test_all_files:

      needs: LintAllPy
      runs-on: ubuntu-latest

      strategy:
            matrix:
                python-version: [3.11] 
      
      

      steps: 
        - name: checkout code
          uses: actions/checkout@v6

        - name: Set image tag
          run: echo "IMAGE_TAG=$(date +%s)" >> $GITHUB_ENV

        - name: Build the testing Docker image
          run: docker build . --file testing/Dockerfile --tag project_plane_testing:${IMAGE_TAG}
        
        - name: run the testing docker 
          run: docker run project_plane_testing:${IMAGE_TAG}

    system_test_using_docker_compose:
      needs: test_all_files
      runs-on: ubuntu-latest

      steps: 
        - name: checkout code
          uses: actions/checkout@v6
        
        - name: docker compose up 
          run: docker compose up -d
        
        - name: Docker Compose Health Check
          uses: jaracogmbh/docker-compose-health-check-action@v1.0.0
          with:
              max-retries: 30
              retry-interval: 10
              compose-file: "docker-compose.yml"
              skip-exited: "true"
              skip-no-healthcheck: "true"
        
        - name: Docker compose down
          run: docker compose down
        
    analyze_security:

      needs: system_test_using_docker_compose

      name: Analyze (${{ matrix.language }})
      # Runner size impacts CodeQL analysis time. To learn more, please see:
      #   - https://gh.io/recommended-hardware-resources-for-running-codeql
      #   - https://gh.io/supported-runners-and-hardware-resources
      #   - https://gh.io/using-larger-runners (GitHub.com only)
      # Consider using larger runners or machines with greater resources for possible analysis time improvements.
      runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
      permissions:
        # required for all workflows
        security-events: write

        # required to fetch internal or private CodeQL packs
        packages: read

        # only required for workflows in private repositories
        actions: read
        contents: read

      strategy:
        fail-fast: false
        matrix:
          include:
          - language: python
            build-mode: none
          # CodeQL supports the following values keywords for 'language': 'actions', 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'rust', 'swift'
          # Use `c-cpp` to analyze code written in C, C++ or both
          # Use 'java-kotlin' to analyze code written in Java, Kotlin or both
          # Use 'javascript-typescript' to analyze code written in JavaScript, TypeScript or both
          # To learn more about changing the languages that are analyzed or customizing the build mode for your analysis,
          # see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning.
          # If you are analyzing a compiled language, you can modify the 'build-mode' for that language to customize how
          # your codebase is analyzed, see https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages
      steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Add any setup steps before running the `github/codeql-action/init` action.
      # This includes steps like installing compilers or runtimes (`actions/setup-node`
      # or others). This is typically only required for manual builds.
      # - name: Setup runtime (example)
      #   uses: actions/setup-example@v1

      # Initializes the CodeQL tools for scanning.
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
          build-mode: ${{ matrix.build-mode }}
          # If you wish to specify custom queries, you can do so here or in a config file.
          # By default, queries listed here will override any specified in a config file.
          # Prefix the list here with "+" to use these queries and those in the config file.

          # For more details on CodeQL's query packs, refer to: https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs
          # queries: security-extended,security-and-quality

      # If the analyze step fails for one of the languages you are analyzing with
      # "We were unable to automatically build your code", modify the matrix above
      # to set the build mode to "manual" for that language. Then modify this step
      # to build your code.
      # â„¹ï¸ Command-line programs to run using the OS shell.
      # ðŸ“š See https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsrun
      - name: Run manual build steps
        if: matrix.build-mode == 'manual'
        shell: bash
        run: |
          echo 'If you are using a "manual" build mode for one or more of the' \
            'languages you are analyzing, replace this with the commands to build' \
            'your code, for example:'
          echo '  make bootstrap'
          echo '  make release'
          exit 1

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:${{matrix.language}}"

    Build_and_push_to_AWS:
      needs: analyze_security
      runs-on: ubuntu-latest
      steps:
        - name: checkout
          uses: actions/checkout@v4

        - name: Debug workspace
          run: |
            echo "Listing workspace:"
            ls -R .

        
        - name: config aws cred
          uses: aws-actions/configure-aws-credentials@v1
          with: 
            aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws-region: eu-north-1

        - name: Login to Amazon ECR
          id: login-ecr
          uses: aws-actions/amazon-ecr-login@v1
          
        - name: Automatic Tagging of Releases
          id: increment-git-tag
          run: |
            NEW_TAG=$(bash ./build/git_update.sh -v patch)
            echo "git-tag=$NEW_TAG" >> $GITHUB_OUTPUT


        - name: Push the Image to Amazon ECR backend
          id: build-image-backend
          env:
            ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            ECR_REPOSITORY: project_plane_backend
            IMAGE_TAG: ${{ steps.increment-git-tag.outputs.git-tag }}
          run: |
            docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f backend/Dockerfile backend
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
            
        - name: Push the Image to Amazon ECR frontend
          id: build-image-frontend
          env:
            ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            ECR_REPOSITORY: project_plane_frontend
            IMAGE_TAG: ${{ steps.increment-git-tag.outputs.git-tag }}
          run: |
            docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f frontend/Dockerfile frontend
            docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

  